{% comment %}
Дерево категорий: аккордеоны с подкатегориями.
Ожидает в контексте: root_categories, current_category (опционально), open_accordion_ids (список id корней для раскрытия).
{% endcomment %}
<nav class="catalog-nav" aria-label="Категории каталога">
  <div class="accordion catalog-accordion" id="catalogCategoryAccordion">
    {% for root in root_categories %}
      {% if root.children.all %}
        <div class="accordion-item catalog-accordion-item border-0">
          <h3 class="accordion-header catalog-accordion-header">
            <div class="d-flex align-items-center w-100 catalog-accordion-header-inner">
              <a href="{% url 'catalog:product_list_by_category' slug=root.slug %}" class="catalog-nav-link catalog-accordion-link flex-grow-1 {% if current_category and current_category.pk == root.pk %}active{% endif %}" onclick="event.stopPropagation()">
                {{ root.name }}
              </a>
              <button class="btn btn-link btn-sm p-0 ms-1 catalog-accordion-toggle flex-shrink-0" type="button" data-bs-toggle="collapse" data-bs-target="#cat-{{ root.pk }}" aria-expanded="{% if root.pk in open_accordion_ids %}true{% else %}false{% endif %}" aria-controls="cat-{{ root.pk }}" aria-label="Подкатегории {{ root.name }}">
                <span class="accordion-toggle-icon" aria-hidden="true"></span>
              </button>
            </div>
          </h3>
          <div id="cat-{{ root.pk }}" class="accordion-collapse collapse {% if root.pk in open_accordion_ids %}show{% endif %}" data-bs-parent="#catalogCategoryAccordion">
            <div class="accordion-body py-1">
              <ul class="nav flex-column catalog-nav-sublist">
                {% for child in root.children.all %}
                  <li class="nav-item">
                    <a class="nav-link catalog-nav-link catalog-nav-sublink {% if current_category and current_category.pk == child.pk %}active{% endif %}" href="{% url 'catalog:product_list_by_category' slug=child.slug %}">
                      {{ child.name }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% else %}
        <div class="accordion-item catalog-accordion-item border-0">
          <div class="catalog-accordion-header catalog-accordion-header-single">
            <a href="{% url 'catalog:product_list_by_category' slug=root.slug %}" class="catalog-nav-link catalog-accordion-link {% if current_category and current_category.pk == root.pk %}active{% endif %}">
              {{ root.name }}
            </a>
          </div>
        </div>
      {% endif %}
    {% empty %}
    <p class="small text-body-secondary mb-0">Нет категорий.</p>
    {% endfor %}
  </div>
</nav>
