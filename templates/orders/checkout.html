{% extends "base.html" %}
{% load static %}

{% block title %}Оформление заказа — {{ site_name }}{% endblock %}

{% block content %}
{% if yandex_maps_api_key %}
<script src="https://api-maps.yandex.ru/v3/?lang=ru_RU&apikey={{ yandex_maps_api_key|urlencode }}" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/@cdek-it/widget@3.11.1/dist/cdek-widget.umd.js" type="text/javascript"></script>
{% endif %}
<div class="container py-4">
  <h2 class="mb-4">Оформление заказа</h2>

  <div class="row">
    <div class="col-lg-7 mb-4">
      <form method="post" id="checkout-form" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="card mb-4">
          <div class="card-header">
            <h3 class="h6 mb-0">Получатель</h3>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="id_recipient_name" class="form-label">{{ form.recipient_name.label }}</label>
              {{ form.recipient_name }}
              {% if form.recipient_name.errors %}
                <div class="text-danger small">{{ form.recipient_name.errors }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="id_recipient_phone" class="form-label">{{ form.recipient_phone.label }}</label>
              {{ form.recipient_phone }}
              {% if form.recipient_phone.errors %}
                <div class="text-danger small">{{ form.recipient_phone.errors }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="id_recipient_email" class="form-label">{{ form.recipient_email.label }}</label>
              {{ form.recipient_email }}
              {% if form.recipient_email.errors %}
                <div class="text-danger small">{{ form.recipient_email.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">
            <h3 class="h6 mb-0">Доставка СДЭК</h3>
          </div>
          <div class="card-body">
            <p class="text-body-secondary small mb-3">
              Отправка товаров из Санкт-Петербурга (ПВЗ).
              Выберите пункт выдачи или адрес на карте, нажмите в карточке кнопку <strong>«Выбрать»</strong>,
              затем укажите вариант доставки в блоке «Варианты доставки» ниже.
            </p>

            {# Скрытые поля: заполняются из виджета через JS #}
            <div class="d-none">
              {{ form.delivery_tariff }}
              {{ form.delivery_mode }}
              {{ form.city_code }}
              {{ form.pvz_code }}
              {{ form.delivery_address }}
            </div>

            {% if not yandex_maps_api_key %}
            <p class="alert alert-warning small mb-3">
              Карта ПВЗ недоступна: не задан ключ Яндекс.Карт (YANDEX_MAPS_API_KEY).
            </p>
            {% endif %}

            {# Виджет СДЭК #}
            <div id="cdek-widget-container" style="width: 100%; height: 500px;"></div>

            {# Выбранный ПВЗ / адрес курьера #}
            <div id="cdek-pvz-selected" class="alert alert-light border small mt-2 mb-0 d-none" role="status">
              <strong>Выбрано:</strong> <span id="cdek-pvz-address"></span>
            </div>

            {# Блок тарифов СДЭК (рассчитываем своим API по выбору в виджете) #}
            <div id="cdek-tariffs-loading" class="small text-muted mt-2 d-none">
              Рассчитываем доступные тарифы доставки…
            </div>
            <div id="cdek-tariffs-panel" class="mt-2 d-none">
              <h4 class="h6 mb-2">Варианты доставки</h4>
              <div id="cdek-tariffs-list" class="d-grid gap-2"></div>
            </div>
            <div id="cdek-tariffs-error" class="alert alert-danger small mt-2 d-none"></div>

            {% if form.pvz_code.errors %}
              <div class="text-danger small mt-1">{{ form.pvz_code.errors }}</div>
            {% endif %}
            {% if form.city_code.errors %}
              <div class="text-danger small mt-1">{{ form.city_code.errors }}</div>
            {% endif %}
            {% if form.delivery_tariff.errors %}
              <div class="text-danger small mt-1">{{ form.delivery_tariff.errors }}</div>
            {% endif %}
            {% if form.delivery_address.errors %}
              <div class="text-danger small mt-1">{{ form.delivery_address.errors }}</div>
            {% endif %}

            {# Подсказка когда для выбранного ПВЗ нет тарифов (одинаковый город) #}
            <div id="cdek-tariff-warning" class="alert alert-warning small mt-2 mb-0 d-none">
              Для выбранного пункта выдачи нет доступных тарифов доставки.
              Пожалуйста, выберите пункт выдачи в другом городе.
            </div>

            <div class="mt-3">
              <label for="id_comment" class="form-label">{{ form.comment.label }}</label>
              {{ form.comment }}
              {% if form.comment.errors %}
                <div class="text-danger small">{{ form.comment.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-4">
          <button type="submit" name="action" value="place_order" class="btn btn-primary">
            Оформить заказ
          </button>
        </div>
      </form>
    </div>

    <div class="col-lg-5">
      <div class="card sticky-top">
        <div class="card-header">
          <h3 class="h6 mb-0">Ваш заказ</h3>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <tbody>
                {% for item in items %}
                  <tr>
                    <td class="ps-0">
                      <a href="{% url 'catalog:product_detail' item.product.pk %}" class="text-decoration-none text-dark">
                        {{ item.product.name }}
                      </a>
                      <span class="text-body-secondary">× {{ item.quantity }}</span>
                    </td>
                    <td class="text-end pe-0">{{ item.line_total|floatformat:0 }} ₽</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-1">
            <span>Товары:</span>
            <span>{{ products_total|floatformat:0 }} ₽</span>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <span>Доставка:</span>
            <span id="delivery-cost-display">
              {% if delivery_cost is not None %}
                {{ delivery_cost|floatformat:0 }} ₽
                {% if delivery_period_min or delivery_period_max %}
                  <span class="text-body-secondary small">
                    ({{ delivery_period_min|default:"—" }}-{{ delivery_period_max|default:"—" }} дн.)
                  </span>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </span>
          </div>
          <hr>
          <div class="d-flex justify-content-between fw-bold fs-5">
            <span>Итого:</span>
            <span id="total-display">{{ total|floatformat:0 }} ₽</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  var cityCodeInput       = document.getElementById('id_city_code');
  var deliveryTariffInput = document.getElementById('id_delivery_tariff');
  var deliveryModeInput   = document.getElementById('id_delivery_mode');
  var productsTotal = parseFloat("{{ products_total|floatformat:2 }}".replace(',', '.')) || 0;

  var tariffsPanel   = document.getElementById('cdek-tariffs-panel');
  var tariffsList    = document.getElementById('cdek-tariffs-list');
  var tariffsLoading = document.getElementById('cdek-tariffs-loading');
  var tariffsError   = document.getElementById('cdek-tariffs-error');

  /* ── Форматирование ── */
  function formatRub(value) {
    if (typeof value !== 'number' || isNaN(value)) return '—';
    return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '\u00a0') + '\u00a0₽';
  }

  function getCsrfToken() {
    var input = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return input ? input.value : '';
  }

  function clearTariffs() {
    if (tariffsList) {
      tariffsList.innerHTML = '';
    }
    if (tariffsPanel) {
      tariffsPanel.classList.add('d-none');
    }
  }

  function renderTariffs(tariffs) {
    clearTariffs();
    if (!tariffsPanel || !tariffsList) return;
    if (!tariffs || !tariffs.length) {
      return;
    }

    tariffs.forEach(function(tariff) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-secondary w-100 text-start cdek-tariff-item';
      btn.dataset.tariffCode = String(tariff.tariff_code);

      var name = tariff.tariff_name || ('Тариф ' + (tariff.tariff_code || ''));
      var desc = tariff.tariff_description || '';
      var cost = Number(tariff.delivery_sum || 0);
      var periodMin = tariff.period_min != null ? tariff.period_min : '—';
      var periodMax = tariff.period_max != null ? tariff.period_max : '—';

      btn.innerHTML =
        '<div class="d-flex justify-content-between align-items-start">' +
          '<div class="me-2">' +
            '<div class="fw-semibold">' + name + '</div>' +
            (desc ? '<div class="small text-body-secondary">' + desc + '</div>' : '') +
          '</div>' +
          '<div class="text-end">' +
            '<div>' + formatRub(cost) + '</div>' +
            '<div class="small text-body-secondary">' + periodMin + '–' + periodMax + ' дн.</div>' +
          '</div>' +
        '</div>';

      btn.addEventListener('click', function() {
        if (!tariffsList) return;
        Array.prototype.forEach.call(
          tariffsList.querySelectorAll('.cdek-tariff-item'),
          function(el) {
            el.classList.remove('active', 'btn-primary');
            el.classList.add('btn-outline-secondary');
          }
        );
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-primary', 'active');

        if (deliveryTariffInput) {
          deliveryTariffInput.value = String(tariff.tariff_code);
        }
        updateSummary(tariff);
      });

      tariffsList.appendChild(btn);
    });

    tariffsPanel.classList.remove('d-none');
  }

  function loadTariffsFromBackend(mode, cityCode, cityName, pointType) {
    if (!mode || (!cityCode && !cityName)) return;
    var url = "{% url 'orders:checkout_tariffs' %}";
    var csrf = getCsrfToken();
    if (!url) return;

    if (tariffsError) {
      tariffsError.textContent = '';
      tariffsError.classList.add('d-none');
    }
    clearTariffs();
    if (tariffsLoading) {
      tariffsLoading.classList.remove('d-none');
    }

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrf
      },
      body: JSON.stringify({
        mode: mode,
        city_code: cityCode,
        city: cityName || '',
        point_type: pointType || ''
      })
    })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        if (tariffsLoading) {
          tariffsLoading.classList.add('d-none');
        }
        if (cityCodeInput && data && data.city_code != null) {
          cityCodeInput.value = String(data.city_code);
        }
        var tariffs = data && Array.isArray(data.tariffs) ? data.tariffs : [];
        renderTariffs(tariffs);
        if (!tariffs.length && mode === 'office') {
          var warning = document.getElementById('cdek-tariff-warning');
          if (warning) {
            warning.classList.remove('d-none');
          }
        }
      })
      .catch(function(error) {
        if (tariffsLoading) {
          tariffsLoading.classList.add('d-none');
        }
        if (tariffsError) {
          tariffsError.textContent = 'Не удалось получить тарифы доставки. Попробуйте позже.';
          tariffsError.classList.remove('d-none');
        }
        // eslint-disable-next-line no-console
        console.warn('CDEK tariffs load error:', error);
      });
  }

  /* ── Обновить блок «Доставка / Итого» в правой колонке ── */
  function updateSummary(tariff) {
    var costEl  = document.getElementById('delivery-cost-display');
    var totalEl = document.getElementById('total-display');
    if (!costEl || !totalEl || !tariff) return;
    var cost = Number(tariff.delivery_sum || 0);
    var html = formatRub(cost);
    if (tariff.period_min != null || tariff.period_max != null) {
      html += ' <span class="text-body-secondary small">('
            + (tariff.period_min != null ? tariff.period_min : '—')
            + '–'
            + (tariff.period_max != null ? tariff.period_max : '—')
            + '\u00a0дн.)</span>';
    }
    costEl.innerHTML = html;
    totalEl.textContent = formatRub(productsTotal + cost);
  }

  /* ── Инициализация виджета ── */
  var cdekWidgetInited = false;
  var cdekServiceUrl   = "{{ cdek_service_url|escapejs }}";
  var yandexMapsApiKey = "{{ yandex_maps_api_key|escapejs }}";

  function initCdekWidget() {
    if (cdekWidgetInited) return;
    if (typeof window.CDEKWidget === 'undefined' || !cdekServiceUrl || !yandexMapsApiKey) return;
    if (!document.getElementById('cdek-widget-container')) return;
    cdekWidgetInited = true;
    try {
      window.cdekWidgetInstance = new window.CDEKWidget({
        defaultLocation: [30.315868, 59.939095],
        root: 'cdek-widget-container',
        apiKey: yandexMapsApiKey,
        servicePath: cdekServiceUrl,
        canChoose: true,
        // Тарифы в виджете не показываем — выбор только по ПВЗ/адресу
        tariffs: {
          office: [],
          pickup: [],
          door:   []
        },
        // Скрыть фильтры оплаты и примерочной; фильтр «Вид ПВЗ» оставляем — им можно выбирать постаматы/ПВЗ
        hideFilters: {
          have_cashless: true,
          have_cash: true,
          is_dressing_room: true,
          type: false
        },
        // Не фиксировать тип точки — пользователь может выбрать «Все», «Только постаматы», «Только ПВЗ»
        forceFilters: {
          type: null
        },
        hideDeliveryOptions: { door: false, office: false },

        // onChoose: пользователь нажал «Выбрать» для другого ПВЗ/адреса — обновляем адрес и пересчитываем тарифы.
        onChoose: function(mode, tariff, address) {
          var pvzInput      = document.getElementById('id_pvz_code');
          var addrTextarea  = document.getElementById('id_delivery_address');
          var addrLabel     = document.getElementById('cdek-pvz-address');
          var selectedBlock = document.getElementById('cdek-pvz-selected');
          var warning       = document.getElementById('cdek-tariff-warning');

          // Сброс предыдущего выбора: тариф, режим, итоги, список тарифов
          if (deliveryTariffInput) deliveryTariffInput.value = '';
          if (deliveryModeInput) deliveryModeInput.value = '';
          clearTariffs();
          var costEl = document.getElementById('delivery-cost-display');
          var totalEl = document.getElementById('total-display');
          if (costEl) costEl.textContent = '—';
          if (totalEl) totalEl.textContent = formatRub(productsTotal);
          if (warning) warning.classList.add('d-none');

          // Заполнить поля адреса по выбранному режиму
          if (mode === 'office' && address) {
            if (pvzInput) pvzInput.value = address.code || '';
            if (cityCodeInput && address.city_code) cityCodeInput.value = address.city_code;
            if (addrTextarea) addrTextarea.value = '';
            var addrText = (address.city || '') + (address.address ? ', ' + address.address : '');
            if (addrLabel) addrLabel.textContent = addrText || address.code || '—';
          } else if (mode === 'door' && address) {
            if (pvzInput) pvzInput.value = '';
            var formatted = address.formatted || address.address || '';
            if (addrLabel) addrLabel.textContent = formatted || '—';
            if (addrTextarea && formatted) addrTextarea.value = formatted;
            // city_code для двери подставится из ответа API после загрузки тарифов
            if (cityCodeInput) cityCodeInput.value = '';
          }

          if (selectedBlock) selectedBlock.classList.remove('d-none');
          if (deliveryModeInput) deliveryModeInput.value = mode;

          // Пересчитать тарифы для нового адреса/ПВЗ (point_type: PVZ или POSTAMAT для режима office)
          var cityCode = null;
          var cityName = null;
          var pointType = null;
          if (mode === 'office' && address) {
            cityCode = address.city_code || null;
            cityName = address.city || null;
            pointType = address.type || null;
          } else if (mode === 'door' && address) {
            cityName = address.city || null;
          }
          if (cityCode || cityName) {
            loadTariffsFromBackend(mode, cityCode, cityName, pointType);
          }
        }
      });
    } catch (e) {
      cdekWidgetInited = false;
      console.warn('CDEK widget init error:', e);
    }
  }

  // Яндекс.Карты v3 инициализируются асинхронно; ждём ymaps3.ready,
  // иначе виджет иногда создаётся раньше карты и падает с ошибкой конструктора.
  function waitForYMapsAndInit() {
    if (typeof window.ymaps3 !== 'undefined' && window.ymaps3.ready) {
      window.ymaps3.ready.then(function() {
        initCdekWidget();
      });
      return;
    }
    setTimeout(waitForYMapsAndInit, 300);
  }

  waitForYMapsAndInit();
})();
</script>
{% endblock %}
